<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é”€å”®æŠ¥ä»·åå°</title>
  <!-- å¼•å…¥intl-tel-input CSSå’ŒJS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input/build/css/intlTelInput.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input/build/js/intlTelInput.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc, addDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIhaNpTF7eOPd4UzH0_WuBHMoKhaZ9f10",
      authDomain: "cnu-tracker.firebaseapp.com",
      projectId: "cnu-tracker",
      storageBucket: "cnu-tracker.appspot.com",
      messagingSenderId: "334145477498",
      appId: "1:334145477498:web:25d2df0ea74fc9d27694c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const thStyle = 'border:1px solid #ccc;padding:8px;background:#f7f7f7';
    const tdStyle = 'border:1px solid #ccc;padding:8px';
    const inputStyle = 'width:80px';

    window.addEventListener("DOMContentLoaded", () => {
      const table = document.getElementById("quoteTableBody");
      const q = query(collection(db, "quotes"), orderBy("createdAt", "desc"));
      onSnapshot(q, (querySnapshot) => {
        table.innerHTML = "";
        querySnapshot.forEach((docSnap) => {
          const q = docSnap.data();
          const id = docSnap.id;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td style='${tdStyle}'>${q.name}</td>
            <td style='${tdStyle}'>${q.product}</td>
            <td style='${tdStyle}'>${q.thickness} Ã— ${q.width}</td>
            <td style='${tdStyle}'>${q.quantity}</td>
            <td style='${tdStyle}'>${q.country}</td>
            <td style='${tdStyle}'>${q.contact}</td>
            <td style='${tdStyle}'>
              <input id='price-${id}' value='${q.price || ""}' style='${inputStyle}' />
            </td>
            <td style='${tdStyle}'>
              <input id='total-${id}' value='${q.total || ""}' style='${inputStyle}' />
            </td>
            <td style='${tdStyle}'>
              <input id='comment-${id}' value='${q.comment || ""}' style='${inputStyle}' />
            </td>
            <td style='${tdStyle}'>
              <button onclick='updateQuote("${id}")' style='padding:6px 12px; background:#28a745; color:white; border:none; border-radius:5px;'>ä¿å­˜</button>
            </td>
          `;
          table.appendChild(row);
        });
      });
    });

    window.updateQuote = async (id) => {
      const price = document.getElementById(`price-${id}`).value;
      const total = document.getElementById(`total-${id}`).value;
      const comment = document.getElementById(`comment-${id}`).value;
      const ref = doc(db, 'quotes', id);
      await updateDoc(ref, { price, total, comment, quoted: true });
      alert('æŠ¥ä»·å·²æ›´æ–°');
    };
  </script>
</head>
<body>
  <div style="padding:30px">
    <h2 style="text-align:center;margin-bottom:20px">ğŸ“Š å®¢æˆ·éœ€æ±‚åˆ—è¡¨ï¼ˆé”€å”®åå°ï¼‰</h2>
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">å§“å</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">äº§å“</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">å°ºå¯¸</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">æ•°é‡</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">å›½å®¶</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">è”ç³»æ–¹å¼</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">å•ä»·</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">æ€»ä»·</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">å¤‡æ³¨</th>
          <th style="border:1px solid #ccc;padding:8px;background:#f7f7f7">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="quoteTableBody"></tbody>
    </table>

    <!-- ç”µè¯å·ç è¾“å…¥æ¡† -->
    <label for="phone">å®¢æˆ·æ‰‹æœºå·ï¼š</label>
    <input id="phone" type="tel" style="width: 100%" />  

    <!-- æäº¤æŒ‰é’® -->
    <button onclick="submitQuote()" style="padding:6px 12px; background:#007bff; color:white; border:none; border-radius:5px;margin-top:10px;">æäº¤æŠ¥ä»·</button>
  </div>

  <script>
    // åˆå§‹åŒ– intl-tel-input
    const input = document.querySelector("#phone");
    const iti = intlTelInput(input, {
      initialCountry: "auto", // è‡ªåŠ¨é€‰æ‹©åˆå§‹å›½å®¶
      geoIpLookup: function(callback) {
        fetch("https://ipinfo.io?token=YOUR_API_KEY")
          .then(response => response.json())
          .then(data => callback(data.country));
      },
      utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input/build/js/utils.js", // ç”¨äºæ ¼å¼åŒ–ç”µè¯å·ç 
    });

    // æäº¤æŠ¥ä»·å‡½æ•°
    function submitQuote() {
      const phoneNumber = iti.getNumber(); // è·å–å®Œæ•´çš„ç”µè¯å·ç 
      const price = document.getElementById('price').value;
      const total = document.getElementById('total').value;
      const comment = document.getElementById('comment').value;

      // éªŒè¯æ‰‹æœºå·
      if (!iti.isValidNumber()) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ");
        return;
      }

      if (phoneNumber && price && total) {
        alert(`æŠ¥ä»·æäº¤æˆåŠŸ!\næ‰‹æœºå·ï¼š${phoneNumber}\nå•ä»·ï¼š${price}\næ€»ä»·ï¼š${total}\nå¤‡æ³¨ï¼š${comment}`);
        // æäº¤æŠ¥ä»·æ•°æ®åˆ°åå°
        addDoc(collection(db, "quotes"), {
          product: "äº§å“",
          spec: "å°ºå¯¸",
          price: price,
          total: total,
          comment: comment,
          phone: phoneNumber,
          createdAt: new Date(),
        }).then(() => {
          alert('æŠ¥ä»·ä¿¡æ¯å·²æäº¤');
        }).catch((error) => {
          alert('æäº¤å¤±è´¥ï¼š' + error.message);
        });
      } else {
        alert("è¯·å¡«å†™å®Œæ•´çš„æŠ¥ä»·ä¿¡æ¯");
      }
    }
  </script>
</body>
</html>
